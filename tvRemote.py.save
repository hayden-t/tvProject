#!/usr/bin/python3
import os
import datetime
import json

import tvControl

import cgitb
cgitb.enable()

#called by apache2 cgi-bin
#a2enmod cgi
#chown root:user (filename)
#chmod 775 (filename)
#ln -s filename /usr/lib/cgi-bin/

now = datetime.datetime.now()

playlist = [{"day": "", "start": "", "stop": "", "record": True, "file": "rtsp://192.168.60.205:554/1"}]

queryString = os.environ.get('QUERY_STRING')

print("Content-Type: text/html;charset=utf-8")
print ("Content-type:text/html\r\n")
print("<title> Channel 700 Live stream camera control</title>")
print("<H2> Channel 700 Live stream camera control</H2>")

#print(queryString)
#print(os.getuid())

if(queryString):
	f = o f = open("/home/user/tvProject/tvRemote.json", "w")pen("/home/user/tvProject/tvRemote.json", "w")
	if('start' in queryString):
	
		length = int(queryString.split('=')[-1])
		#print(length)

		
		start = now + datetime.timedelta(minutes=1)
		playlist[0]['day'] = now.isoweekday()
		playlist[0]['start'] = start.strftime('%H%M')
		
		stop = start + datetime.timedelta(hours=length)
		playlist[0]['stop'] = stop.strftime('%H%M')
		

		f.write(json.dumps(playlist))
		
		print('<p>Camera will start streaming for '+ str(length) +' hour/s within 1 minute</p>')
		
		
	elif(queryString == 'stop=1'):	
		
		print('<p>Stream stopped</p>')
		#f.write('')
		tvControl.vlcStop()
	
	print("<p><a href='/cgi-bin/tvRemote.py'>Return to Menu</a></p>")	
	f.close()
	
else:
	print("<p><a href='/cgi-bin/tvRemote.py?start=1'>Start stream and record for 1 Hour</a></p>")
	print("<p><a href='/cgi-bin/tvRemote.py?start=2'>Start stream and record for 2 Hour</a></p>")
	print("<p><a href='/cgi-bin/tvRemote.py?start=3'>Start stream and record for 3 Hour</a></p>")

	print("<p><a href='/cgi-bin/tvRemote.py?stop=1'>Stop Stream</a></p>")


